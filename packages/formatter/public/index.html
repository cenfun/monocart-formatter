<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link rel="icon" href="data:,">
    <title>monocart-formatter</title>
    <!--inject:start-->
    <script src="../dist/monocart-formatter.js"></script>
    <!--inject:end-->
</head>

<body>
    <script>
        const { format, Mapping } = window['monocart-formatter'];

        const checkMapping = (original, formatted, formattedMapping) => {
            const emptyReg = /\s/;
            const mapping = new Mapping(formatted, formattedMapping);
            for (let i = 0, l = original.length; i < l; i++) {
                const s1 = original[i];
                if (emptyReg.test(s1)) {
                    continue;
                }
                const loc = mapping.getFormattedLocation(i);
                const j = loc.start + loc.column;
                // out of text, original has more non-null characters
                if (j >= formatted.length) {
                    continue;
                }
                const s2 = formatted[j];
                if (s1 !== s2) {
                    console.error([i, j], [s1, s2], loc);
                }
            }

        };

        const testMapping = () => {
            const list = [
                ['aaa', 'aaa'],
                ['a  a  a', 'a\na\na'],
                ['var  a=1;var b;', 'var a = 1;\nvar b;'],
                ['aaa', 'a a a '],
                ['aaa ', 'a a a'],
                ['aaab', 'a a a'],
                ['aaa', 'a a ab'],
                // error case
                ['  error case', '   a a a']
            ];

            list.forEach((arr) => {
                const generatedMapping = Mapping.generate(arr[0], arr[1]);
                console.log(arr, generatedMapping);
                if (generatedMapping.error) {
                    console.log('here is mapping error');
                    console.error(arr, generatedMapping.error);
                } else {
                    checkMapping(arr[0], arr[1], generatedMapping);
                }
            });

            const original = 'aaa\n\tbbb\t ccc';
            const formatted = 'aaa\n    bbb\n    \nccc';
            const generatedMapping = Mapping.generate(original, formatted);
            const mapping = new Mapping(formatted, generatedMapping);
            console.log([original, formatted], generatedMapping);
            const loc1 = mapping.getFormattedLocation(4);
            const s1 = formatted[loc1.start + loc1.column];
            console.assert(s1 === ' ');

            const loc2 = mapping.getFormattedLocation(4, true);
            const s2 = formatted[loc2.start + loc2.column];
            console.assert(s2 === 'b');

            const loc3 = mapping.getFormattedLocation(9, true);
            console.log(loc3, original[9]);
            const s3 = formatted[loc3.start + loc3.column];
            console.log([s3]);
            console.assert(loc3.indent === 4);
        };

        const loadTestCases = async () => {
            const res = await fetch('test/test-cases.json');
            // console.log(res);
            const json = await res.json();
            return json;
        };

        const testFormat = async (testCases) => {
            for (const item of testCases) {

                console.log('===========================================', item.name);
                const { content, mapping } = await format(item.content, item.type);
                console.log(mapping);
                console.assert(content, item.formattedContent);

            }
        };

        window.onload = async () => {
            testMapping();
            const testCases = await loadTestCases();
            console.log(testCases);
            await testFormat(testCases);

        };

    </script>
</body>

</html>