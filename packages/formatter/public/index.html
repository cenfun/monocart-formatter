<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link rel="icon" href="data:,">
    <title>monocart-formatter</title>
    <style>
        table {
            width: 100%;
        }

        table td {
            text-align: center;
        }

        textarea {
            width: 500px;
            height: 160px;
        }

    </style>
    <!--inject:start-->
    <script src="../dist/monocart-formatter.js"></script>
    <!--inject:end-->
</head>

<body>
    <table>
        <tr>
            <td><textarea class="input-js">console.log(1); var a=true;if(a){console.log(a)}
        
var b = 2;

const foo = () => {

};

const bar = ()=> {

};
                </textarea></td>
                <td>
                    <button class="format-js">format-js</button>
                    <div class="duration-js"></div>
                </td>
                <td><textarea class="output-js"></textarea></td>
        </tr>
        <tr>
            <td><textarea class="input-css">.red {
    color: red;
}

.unused,.and-used {
    position: relative;
}

/* comments */
.inline-unused{font-size:medium;}.inline-used {position:relative;}.next-unused{color:none}
            </textarea></td>
            <td>
                <button class="format-css">format-css</button>
                <div class="duration-css"></div>
            </td>
            <td><textarea class="output-css"></textarea></td>
        </tr>
        <tr>
            <td><textarea class="input-html"></textarea></td>
            <td>
                <button class="format-html">format-html</button>
                <div class="duration-html"></div>
            </td>
            <td><textarea class="output-html"></textarea></td>
        </tr>
        <tr>
            <td><textarea class="input-json">{"a":"1",
                "build-worker": "sf b worker -p","build-formatter": "sf b formatter -p",
                 "build": "sf lint && npm run build-worker && npm run build-formatter",
                "patch": "npm run build && sf publish patch"
            }
            </textarea></td>
            <td>
                <button class="format-json">format-json</button>
                <div class="duration-json"></div>
            </td>
            <td><textarea class="output-json"></textarea></td>
        </tr>
    </table>
    <script>
        const { format, Mapping } = window['monocart-formatter'];

        const checkMapping = (res, original) => {
            const formatted = res.content;
            const emptyReg = /\s/;
            const mapping = new Mapping(formatted, res.mapping);
            for (let i = 0, l = original.length; i < l; i++) {
                const loc = mapping.originalToFormatted(i);
                const s1 = original[i];
                if (emptyReg.test(s1)) {
                    continue;
                }
                const s2 = formatted[loc.offset + loc.column];
                if (s1 !== s2) {
                    console.error(i, loc.line, JSON.stringify(s1), JSON.stringify(s2));
                }
            }

        };

        document.querySelector('.input-html').value = `
        <!DOCTYPE html>
            <html>
                <head>
                    <meta charset="utf-8">
                    <title>title</title>
                    <style>
                        table { width: 100%;}
                        table td { text-align: center; }
                    </style>
                </head>
                <body>
                    <div><div>
                    <span>
                </body>
            </html>
        `;

        const ls = ['js', 'css', 'html', 'json'];

        ls.forEach((k) => {

            document.querySelector(`.format-${k}`).addEventListener('click', async () => {
        
                const time_start = Date.now();
                const original = document.querySelector(`.input-${k}`).value;

                const res = await format(original, k);
                console.log(res);

                const duration = Date.now() - time_start;
                document.querySelector(`.duration-${k}`).innerHTML = duration.toLocaleString();

                if (res.error) {
                    console.error(res.error.message);
                    return;
                }

                document.querySelector(`.output-${k}`).value = res.content;

                checkMapping(res, original);

            });

        });

    </script>
</body>

</html>